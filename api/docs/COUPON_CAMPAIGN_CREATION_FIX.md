# Coupon Campaign Creation Fix

## Issue
The endpoint `POST /api/v1/admin/coupon-campaigns` was returning **400 Bad Request** errors when trying to create new coupon campaigns.

## Root Causes Identified

### 1. Slug Validation Issue
**Problem**: The `CouponCampaign` model had the `slug` field marked as `required: true`, but the slug was supposed to be auto-generated by a pre-save hook. Mongoose was validating the required field before the pre-save hook could run.

**Solution**: Modified the slug field definition in `/Users/surv/Work/zyvo/api/models/CouponCampaign.js`:

```javascript
// Before (causing validation error)
slug: {
  type: String,
  required: true,
  unique: true,
  lowercase: true,
  trim: true
}

// After (allows pre-save hook to set it)
slug: {
  type: String,
  unique: true,
  lowercase: true,
  trim: true,
  validate: {
    validator: function(value) {
      return value && value.length > 0;
    },
    message: 'Slug is required and cannot be empty'
  }
}
```

### 2. Authentication Object Reference Issue
**Problem**: The controller was trying to access `req.admin.id` for logging, but the authentication middleware sets `req.user`, not `req.admin`.

**Solution**: Fixed all instances in `/Users/surv/Work/zyvo/api/controllers/couponCampaign.controller.js`:

```javascript
// Before (causing 500 error)
admin_id: req.admin.id

// After (working correctly)
admin_id: req.user._id || req.user.id
```

## Test Results

✅ **All campaign creation scenarios now working:**

### Minimal Campaign
```bash
curl -X POST "http://localhost:3100/api/v1/admin/coupon-campaigns" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Campaign",
    "discount_type": "PERCENTAGE",
    "discount_value": 10,
    "valid_from": "2025-07-25T00:00:00.000Z",
    "valid_until": "2025-08-01T23:59:59.000Z"
  }'
```

### Complete Campaign with All Options
```bash
curl -X POST "http://localhost:3100/api/v1/admin/coupon-campaigns" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Summer Sale 2025",
    "description": "Get amazing discounts this summer",
    "code_prefix": "SUMMER",
    "discount_type": "PERCENTAGE",
    "discount_value": 25,
    "min_purchase_amount": 100,
    "max_coupon_discount": 50,
    "valid_from": "2025-07-25T00:00:00.000Z",
    "valid_until": "2025-08-22T23:59:59.000Z",
    "max_global_usage": 1000,
    "max_usage_per_user": 1,
    "is_unique_per_user": true,
    "eligibility_criteria": ["NEW_USER"],
    "is_active": true
  }'
```

### Different Discount Types
- ✅ `PERCENTAGE` - Working
- ✅ `AMOUNT` - Working  
- ✅ `FREE_SHIPPING` - Working

## Validation Rules

The endpoint validates all these fields properly:

| Field | Type | Required | Validation |
|-------|------|----------|------------|
| `name` | String | Yes | 3-100 chars, unique |
| `discount_type` | String | Yes | PERCENTAGE, AMOUNT, FREE_SHIPPING |
| `discount_value` | Number | Yes | ≥0, ≤100 for PERCENTAGE |
| `valid_from` | Date | Yes | Cannot be in past |
| `valid_until` | Date | Yes | Must be after valid_from |
| `description` | String | No | ≤500 chars |
| `code_prefix` | String | No | ≤20 chars, uppercase |
| `min_purchase_amount` | Number | No | ≥0 |
| `max_coupon_discount` | Number | No | >0 for PERCENTAGE |
| `max_global_usage` | Number | No | ≥1 |
| `max_usage_per_user` | Number | No | 1-10 |
| `eligibility_criteria` | Array | No | Valid criteria values |

## Response Format

**Success (201 Created):**
```json
{
  "success": true,
  "message": "Coupon campaign created successfully",
  "data": {
    "_id": "6880c50ae6c28f4553185fce",
    "name": "Fixed Amount Special",
    "slug": "fixed-amount-special",
    "discount_type": "AMOUNT",
    "discount_value": 10,
    "valid_from": "2025-07-25T00:00:00.000Z",
    "valid_until": "2025-08-15T23:59:59.000Z",
    "is_active": true,
    // ... additional fields
  }
}
```

**Error (400 Bad Request):**
```json
{
  "success": false,
  "message": "Validation failed",
  "errors": [
    {
      "field": "name",
      "message": "Name must be between 3 and 100 characters"
    }
  ]
}
```

## Summary

The `POST /api/v1/admin/coupon-campaigns` endpoint is now **fully functional** and can create coupon campaigns with all supported discount types and validation rules. The issues were:

1. ✅ **Slug auto-generation** - Fixed model validation
2. ✅ **Authentication logging** - Fixed req.admin → req.user reference  
3. ✅ **All discount types working** - PERCENTAGE, AMOUNT, FREE_SHIPPING
4. ✅ **Proper error handling** - Validation and duplicate errors handled correctly

The endpoint now returns **201 Created** for successful campaign creation!
